# Dockerfile pour dÃ©veloppement TypeScript avec hot-reload
FROM node:18-alpine

WORKDIR /app

# Installer les dÃ©pendances globales
RUN npm install -g typescript live-server

# Copier les fichiers de configuration
COPY package*.json ./
COPY tsconfig.json ./

# Installer les dÃ©pendances du projet
RUN npm install

# Copier tout le code source (sera aussi montÃ© en volume)
COPY . .

# Exposer les ports
EXPOSE 3000

# CrÃ©er le script de dÃ©marrage
RUN printf '#!/bin/sh\n\
set -e\n\
\n\
# Fonction pour arrÃªter proprement les processus\n\
cleanup() {\n\
    echo ""\n\
    echo "ğŸ›‘ Shutting down development server..."\n\
    kill $TSC_PID $LIVE_PID 2>/dev/null || true\n\
    exit 0\n\
}\n\
\n\
# Capturer SIGTERM et SIGINT pour arrÃªt propre\n\
trap cleanup SIGTERM SIGINT\n\
\n\
echo "ğŸ® Starting Transcendence Development Server..."\n\
echo "ğŸ“¦ Installing/updating dependencies..."\n\
npm install\n\
echo "ğŸ”¨ Compiling TypeScript files (initial build)..."\n\
tsc\n\
if [ $? -eq 0 ]; then\n\
    echo "âœ… TypeScript compilation successful!"\n\
else\n\
    echo "âš ï¸  TypeScript compilation had errors"\n\
fi\n\
echo "ğŸ‘€ Starting TypeScript compiler in watch mode..."\n\
tsc --watch &\n\
TSC_PID=$!\n\
echo "â³ Waiting 2 seconds for initial compilation..."\n\
sleep 2\n\
echo "ğŸŒ Starting live server on port 3000..."\n\
cd pong\n\
live-server --port=3000 --host=0.0.0.0 --no-browser --watch=. --wait=1000 &\n\
LIVE_PID=$!\n\
echo ""\n\
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"\n\
echo "â•‘  âœ… Development server ready!                            â•‘"\n\
echo "â•‘  ğŸŒ URL: http://localhost:3000                           â•‘"\n\
echo "â•‘  ğŸ“ TypeScript auto-compile: ENABLED                     â•‘"\n\
echo "â•‘  ğŸ”„ Live reload: ENABLED                                 â•‘"\n\
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"\n\
echo ""\n\
wait $TSC_PID $LIVE_PID\n\
' > /start-dev.sh && chmod +x /start-dev.sh

CMD ["/start-dev.sh"]